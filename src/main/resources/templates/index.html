<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${serverName} + ' - Estad√≠sticas'">Minecraft Stats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .minecraft-font { font-family: 'Courier New', monospace; }
        .card-hover:hover { transform: translateY(-2px); transition: transform 0.2s; }
        .gradient-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); }
        .live-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .event-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .custom-scroll { scrollbar-width: thin; scrollbar-color: #4b5563 transparent; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold minecraft-font mb-4">
                <i class="fas fa-cube text-green-500 mr-3"></i>
                <span th:text="${serverName}">Server Stats</span>
            </h1>
            <div class="flex justify-center items-center flex-wrap gap-4 text-gray-400">
                <span id="connection-status" class="flex items-center">
                    <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                    Conectando...
                </span>
                <span>‚Ä¢</span>
                <span class="flex items-center">
                    <i class="fas fa-calendar mr-2"></i>
                    <span id="server-date">-</span>
                </span>
                <span>‚Ä¢</span>
                <span class="flex items-center text-xl font-mono text-green-400">
                    <i class="fas fa-clock mr-2"></i>
                    <span id="server-time" class="live-indicator">--:--:--</span>
                </span>
                <span>‚Ä¢</span>
                <span class="text-xs">
                    Actualizado: <span id="last-update" th:text="${stats.lastUpdated}">-</span>
                </span>
            </div>
        </header>

        <!-- Live Status Bar -->
        <section class="mb-8">
            <div class="bg-gray-800/70 rounded-lg p-4 flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <div id="server-status" class="flex items-center">
                        <span class="w-3 h-3 bg-green-500 rounded-full mr-2 live-indicator"></span>
                        <span class="font-bold">Servidor Online</span>
                    </div>
                    <div class="text-gray-400">|</div>
                    <div id="online-players-count" class="flex items-center">
                        <i class="fas fa-users text-green-400 mr-2"></i>
                        <span id="player-count">0</span>/<span id="max-players">10</span> jugadores
                    </div>
                </div>
                <div id="online-players-list" class="flex flex-wrap gap-2">
                    <!-- Online players will be inserted here -->
                </div>
            </div>
        </section>

        <!-- Server Totals -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-server text-blue-400 mr-3"></i>
                Totales del Servidor
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-users text-3xl text-green-400 mb-2"></i>
                    <p class="text-2xl font-bold" th:text="${stats.totalPlayers}">0</p>
                    <p class="text-gray-400 text-sm">Jugadores</p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-cubes text-3xl text-yellow-400 mb-2"></i>
                    <p class="text-2xl font-bold" th:text="${#numbers.formatInteger(stats.serverTotals.totalBlocksMined, 1, 'COMMA')}">0</p>
                    <p class="text-gray-400 text-sm">Bloques Minados</p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-hammer text-3xl text-orange-400 mb-2"></i>
                    <p class="text-2xl font-bold" th:text="${#numbers.formatInteger(stats.serverTotals.totalItemsCrafted, 1, 'COMMA')}">0</p>
                    <p class="text-gray-400 text-sm">Items Crafteados</p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-skull text-3xl text-red-400 mb-2"></i>
                    <p class="text-2xl font-bold" th:text="${#numbers.formatInteger(stats.serverTotals.totalMobsKilled, 1, 'COMMA')}">0</p>
                    <p class="text-gray-400 text-sm">Mobs Eliminados</p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-heart-crack text-3xl text-pink-400 mb-2"></i>
                    <p class="text-2xl font-bold" th:text="${stats.serverTotals.totalDeaths}">0</p>
                    <p class="text-gray-400 text-sm">Muertes Totales</p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-hourglass-half text-3xl text-purple-400 mb-2"></i>
                    <p class="text-2xl font-bold" th:text="${stats.serverTotals.totalPlayTimeFormatted}">0h</p>
                    <p class="text-gray-400 text-sm">Tiempo Jugado</p>
                </div>
            </div>
        </section>

        <!-- Leaderboards -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-trophy text-yellow-400 mr-3"></i>
                Leaderboards
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Most Blocks Mined -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-pickaxe text-yellow-400 mr-2"></i>
                        M√°s Bloques Minados
                    </h3>
                    <ul class="space-y-2">
                        <li th:each="entry, stat : ${stats.leaderboards.mostBlocksMined}" 
                            class="flex justify-between items-center py-2 border-b border-gray-700 last:border-0">
                            <span class="flex items-center">
                                <span th:class="${entry.rank == 1 ? 'text-yellow-400' : (entry.rank == 2 ? 'text-gray-400' : (entry.rank == 3 ? 'text-orange-600' : 'text-gray-500'))}"
                                      class="w-6 font-bold" th:text="'#' + ${entry.rank}">#1</span>
                                <a th:href="@{/player/{uuid}(uuid=${entry.playerUuid})}" 
                                   class="ml-2 hover:text-green-400 transition-colors"
                                   th:text="${entry.playerName}">Player</a>
                            </span>
                            <span class="text-green-400 font-mono" th:text="${#numbers.formatInteger(entry.value, 1, 'COMMA')}">0</span>
                        </li>
                    </ul>
                </div>

                <!-- Most Mobs Killed -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-skull-crossbones text-red-400 mr-2"></i>
                        M√°s Mobs Eliminados
                    </h3>
                    <ul class="space-y-2">
                        <li th:each="entry : ${stats.leaderboards.mostMobsKilled}" 
                            class="flex justify-between items-center py-2 border-b border-gray-700 last:border-0">
                            <span class="flex items-center">
                                <span th:class="${entry.rank == 1 ? 'text-yellow-400' : (entry.rank == 2 ? 'text-gray-400' : (entry.rank == 3 ? 'text-orange-600' : 'text-gray-500'))}"
                                      class="w-6 font-bold" th:text="'#' + ${entry.rank}">#1</span>
                                <a th:href="@{/player/{uuid}(uuid=${entry.playerUuid})}" 
                                   class="ml-2 hover:text-green-400 transition-colors"
                                   th:text="${entry.playerName}">Player</a>
                            </span>
                            <span class="text-red-400 font-mono" th:text="${#numbers.formatInteger(entry.value, 1, 'COMMA')}">0</span>
                        </li>
                    </ul>
                </div>

                <!-- Most Play Time -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-clock text-purple-400 mr-2"></i>
                        M√°s Tiempo Jugado
                    </h3>
                    <ul class="space-y-2">
                        <li th:each="entry : ${stats.leaderboards.mostPlayTime}" 
                            class="flex justify-between items-center py-2 border-b border-gray-700 last:border-0">
                            <span class="flex items-center">
                                <span th:class="${entry.rank == 1 ? 'text-yellow-400' : (entry.rank == 2 ? 'text-gray-400' : (entry.rank == 3 ? 'text-orange-600' : 'text-gray-500'))}"
                                      class="w-6 font-bold" th:text="'#' + ${entry.rank}">#1</span>
                                <a th:href="@{/player/{uuid}(uuid=${entry.playerUuid})}" 
                                   class="ml-2 hover:text-green-400 transition-colors"
                                   th:text="${entry.playerName}">Player</a>
                            </span>
                            <span class="text-purple-400 font-mono" th:text="${entry.formattedValue}">0h</span>
                        </li>
                    </ul>
                </div>

                <!-- Most Deaths -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-heart-crack text-pink-400 mr-2"></i>
                        M√°s Muertes
                    </h3>
                    <ul class="space-y-2">
                        <li th:each="entry : ${stats.leaderboards.mostDeaths}" 
                            class="flex justify-between items-center py-2 border-b border-gray-700 last:border-0">
                            <span class="flex items-center">
                                <span th:class="${entry.rank == 1 ? 'text-yellow-400' : (entry.rank == 2 ? 'text-gray-400' : (entry.rank == 3 ? 'text-orange-600' : 'text-gray-500'))}"
                                      class="w-6 font-bold" th:text="'#' + ${entry.rank}">#1</span>
                                <a th:href="@{/player/{uuid}(uuid=${entry.playerUuid})}" 
                                   class="ml-2 hover:text-green-400 transition-colors"
                                   th:text="${entry.playerName}">Player</a>
                            </span>
                            <span class="text-pink-400 font-mono" th:text="${entry.value}">0</span>
                        </li>
                    </ul>
                </div>

                <!-- Most Distance Walked -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-person-walking text-blue-400 mr-2"></i>
                        M√°s Distancia Recorrida
                    </h3>
                    <ul class="space-y-2">
                        <li th:each="entry : ${stats.leaderboards.mostDistanceWalked}" 
                            class="flex justify-between items-center py-2 border-b border-gray-700 last:border-0">
                            <span class="flex items-center">
                                <span th:class="${entry.rank == 1 ? 'text-yellow-400' : (entry.rank == 2 ? 'text-gray-400' : (entry.rank == 3 ? 'text-orange-600' : 'text-gray-500'))}"
                                      class="w-6 font-bold" th:text="'#' + ${entry.rank}">#1</span>
                                <a th:href="@{/player/{uuid}(uuid=${entry.playerUuid})}" 
                                   class="ml-2 hover:text-green-400 transition-colors"
                                   th:text="${entry.playerName}">Player</a>
                            </span>
                            <span class="text-blue-400 font-mono" th:text="${entry.formattedValue}">0 km</span>
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Detailed Server Stats -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-chart-bar text-purple-400 mr-3"></i>
                Estad√≠sticas Detalladas del Servidor
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <!-- Total Damage Dealt -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-sword text-red-400 text-2xl mb-2"></i>
                    <p class="text-2xl font-bold text-red-400" id="total-damage"
                       th:text="${#numbers.formatInteger(stats.serverTotals.totalDamageDealt, 1, 'COMMA')}">0</p>
                    <p class="text-xs text-gray-400">Da√±o Infligido</p>
                </div>
                <!-- Total Distance -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-route text-blue-400 text-2xl mb-2"></i>
                    <p class="text-2xl font-bold text-blue-400" id="total-distance"
                       th:text="${#numbers.formatDecimal(stats.serverTotals.totalDistanceTraveled / 100000.0, 1, 'COMMA', 1, 'POINT')} + ' km'">0 km</p>
                    <p class="text-xs text-gray-400">Distancia Total</p>
                </div>
                <!-- Chests Opened -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-box-open text-yellow-400 text-2xl mb-2"></i>
                    <p class="text-2xl font-bold text-yellow-400" id="total-chests"
                       th:text="${#numbers.formatInteger(stats.serverTotals.totalChestsOpened, 1, 'COMMA')}">0</p>
                    <p class="text-xs text-gray-400">Cofres Abiertos</p>
                </div>
                <!-- Total Blocks -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-cubes text-green-400 text-2xl mb-2"></i>
                    <p class="text-2xl font-bold text-green-400" id="total-blocks"
                       th:text="${#numbers.formatInteger(stats.serverTotals.totalBlocksMined, 1, 'COMMA')}">0</p>
                    <p class="text-xs text-gray-400">Bloques Minados</p>
                </div>
                <!-- Total Crafted -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-hammer text-orange-400 text-2xl mb-2"></i>
                    <p class="text-2xl font-bold text-orange-400" id="total-crafted"
                       th:text="${#numbers.formatInteger(stats.serverTotals.totalItemsCrafted, 1, 'COMMA')}">0</p>
                    <p class="text-xs text-gray-400">Items Crafteados</p>
                </div>
                <!-- Total Mobs -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-skull text-pink-400 text-2xl mb-2"></i>
                    <p class="text-2xl font-bold text-pink-400" id="total-mobs"
                       th:text="${#numbers.formatInteger(stats.serverTotals.totalMobsKilled, 1, 'COMMA')}">0</p>
                    <p class="text-xs text-gray-400">Mobs Eliminados</p>
                </div>
            </div>
        </section>

        <!-- Player Detailed Stats -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-user-chart text-cyan-400 mr-3"></i>
                Estad√≠sticas por Jugador
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div th:each="player : ${stats.players}" class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <div class="flex items-center mb-4">
                        <img th:src="'https://mc-heads.net/avatar/' + ${player.name} + '/48'" 
                             class="w-12 h-12 rounded-lg mr-3" alt="Avatar">
                        <div>
                            <h3 class="font-bold text-lg" th:text="${player.name}">Player</h3>
                            <p class="text-sm text-gray-400" th:text="${player.summary.playTimeFormatted}">0h 0m</p>
                        </div>
                    </div>
                    
                    <!-- Combat Stats -->
                    <div class="mb-3" th:if="${player.detailedStats != null}">
                        <p class="text-xs text-gray-500 uppercase mb-2">‚öîÔ∏è Combate</p>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Da√±o infligido:</span>
                                <span class="text-red-400" th:text="${#numbers.formatInteger(player.detailedStats.damageDealt, 1, 'COMMA')}">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Da√±o recibido:</span>
                                <span class="text-orange-400" th:text="${#numbers.formatInteger(player.detailedStats.damageTaken, 1, 'COMMA')}">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Bloqueado:</span>
                                <span class="text-blue-400" th:text="${#numbers.formatInteger(player.detailedStats.damageBlocked, 1, 'COMMA')}">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Muertes:</span>
                                <span class="text-pink-400" th:text="${player.summary.totalDeaths}">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Movement Stats -->
                    <div class="mb-3" th:if="${player.detailedStats != null}">
                        <p class="text-xs text-gray-500 uppercase mb-2">üö∂ Movimiento</p>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Caminando:</span>
                                <span class="text-green-400" th:text="${#numbers.formatDecimal(player.detailedStats.walkDistance / 100000.0, 1, 'COMMA', 1, 'POINT')} + ' km'">0 km</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Sprint:</span>
                                <span class="text-green-400" th:text="${#numbers.formatDecimal(player.detailedStats.sprintDistance / 100000.0, 1, 'COMMA', 1, 'POINT')} + ' km'">0 km</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Barco:</span>
                                <span class="text-blue-400" th:text="${#numbers.formatDecimal(player.detailedStats.boatDistance / 100000.0, 1, 'COMMA', 1, 'POINT')} + ' km'">0 km</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Caballo:</span>
                                <span class="text-yellow-400" th:text="${#numbers.formatDecimal(player.detailedStats.horseDistance / 100000.0, 1, 'COMMA', 1, 'POINT')} + ' km'">0 km</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Nadando:</span>
                                <span class="text-cyan-400" th:text="${#numbers.formatDecimal(player.detailedStats.swimDistance / 100000.0, 1, 'COMMA', 1, 'POINT')} + ' km'">0 km</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Volando:</span>
                                <span class="text-purple-400" th:text="${#numbers.formatDecimal(player.detailedStats.flyDistance / 100000.0, 1, 'COMMA', 1, 'POINT')} + ' km'">0 km</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Interaction Stats -->
                    <div th:if="${player.detailedStats != null}">
                        <p class="text-xs text-gray-500 uppercase mb-2">üéÆ Interacciones</p>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Cofres:</span>
                                <span class="text-yellow-400" th:text="${player.detailedStats.chestsOpened}">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Crafteos:</span>
                                <span class="text-orange-400" th:text="${player.detailedStats.craftingTableUses}">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Hornos:</span>
                                <span class="text-red-400" th:text="${player.detailedStats.furnaceUses}">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Dormido:</span>
                                <span class="text-purple-400" th:text="${player.detailedStats.timesSlept}">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Comercios:</span>
                                <span class="text-emerald-400" th:text="${player.detailedStats.villagersTraded}">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Pesca:</span>
                                <span class="text-blue-400" th:text="${player.detailedStats.fishCaught}">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Server Records -->
        <section class="mb-12" id="records-section">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-trophy text-yellow-400 mr-3"></i>
                üèÜ Records del Servidor
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4" id="records-container">
                <p class="text-gray-500">Cargando records...</p>
            </div>
        </section>

        <!-- Item Statistics -->
        <section class="mb-12" id="items-section">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-box text-orange-400 mr-3"></i>
                üì¶ Estad√≠sticas de Items
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Top Mined -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-pickaxe text-gray-400 mr-2"></i>
                        ‚õèÔ∏è Bloques M√°s Minados
                    </h3>
                    <div id="top-mined" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
                
                <!-- Top Used -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-hand-pointer text-blue-400 mr-2"></i>
                        üñ±Ô∏è Items M√°s Usados
                    </h3>
                    <div id="top-used" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
                
                <!-- Top Crafted -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-hammer text-orange-400 mr-2"></i>
                        üî® Items M√°s Crafteados
                    </h3>
                    <div id="top-crafted" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
                
                <!-- Top Killed Mobs -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-skull text-red-400 mr-2"></i>
                        üíÄ Mobs M√°s Eliminados
                    </h3>
                    <div id="top-killed" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
                
                <!-- Deaths by Mob -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-skull-crossbones text-pink-400 mr-2"></i>
                        ‚ò†Ô∏è Muertes por Mob
                    </h3>
                    <div id="top-killed-by" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
                
                <!-- Top Picked Up -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-hand-holding text-green-400 mr-2"></i>
                        ü§≤ Items M√°s Recogidos
                    </h3>
                    <div id="top-picked-up" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Activity Analysis -->
        <section class="mb-12" id="activity-section">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-chart-line text-cyan-400 mr-3"></i>
                üìà An√°lisis de Actividad (30 d√≠as)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Most Active Hour -->
                <div class="bg-gray-800/50 rounded-lg p-6 text-center card-hover">
                    <i class="fas fa-clock text-yellow-400 text-3xl mb-3"></i>
                    <p class="text-3xl font-bold text-yellow-400" id="most-active-hour">--:00</p>
                    <p class="text-sm text-gray-400">Hora M√°s Activa</p>
                </div>
                
                <!-- Most Active Day -->
                <div class="bg-gray-800/50 rounded-lg p-6 text-center card-hover">
                    <i class="fas fa-calendar-day text-green-400 text-3xl mb-3"></i>
                    <p class="text-2xl font-bold text-green-400" id="most-active-day">-</p>
                    <p class="text-sm text-gray-400">D√≠a M√°s Activo</p>
                </div>
                
                <!-- Peak Players -->
                <div class="bg-gray-800/50 rounded-lg p-6 text-center card-hover">
                    <i class="fas fa-users text-blue-400 text-3xl mb-3"></i>
                    <p class="text-3xl font-bold text-blue-400" id="peak-players">0</p>
                    <p class="text-sm text-gray-400">Pico de Jugadores</p>
                    <p class="text-xs text-gray-500" id="peak-players-date">-</p>
                </div>
                
                <!-- Total Sessions -->
                <div class="bg-gray-800/50 rounded-lg p-6 text-center card-hover">
                    <i class="fas fa-door-open text-purple-400 text-3xl mb-3"></i>
                    <p class="text-3xl font-bold text-purple-400" id="total-sessions">0</p>
                    <p class="text-sm text-gray-400">Sesiones Totales</p>
                </div>
            </div>
            
            <!-- Hourly Activity Chart (Simple) -->
            <div class="bg-gray-800/50 rounded-lg p-6 mt-6">
                <h3 class="text-lg font-bold mb-4">‚è∞ Actividad por Hora</h3>
                <div id="hourly-chart" class="flex items-end justify-between h-32 gap-1">
                    <!-- Generated by JS -->
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-2">
                    <span>00:00</span>
                    <span>06:00</span>
                    <span>12:00</span>
                    <span>18:00</span>
                    <span>23:00</span>
                </div>
            </div>
        </section>

        <!-- Recent Sessions -->
        <section class="mb-12" id="sessions-section">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-history text-purple-400 mr-3"></i>
                üïê Sesiones Recientes
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Session Stats -->
                <div class="bg-gray-800/50 rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4">üìä Estad√≠sticas de Sesiones</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Sesi√≥n promedio:</span>
                            <span class="text-green-400 font-mono" id="avg-session">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Sesi√≥n m√°s larga:</span>
                            <span class="text-yellow-400 font-mono" id="longest-session">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Por:</span>
                            <span class="text-yellow-400" id="longest-session-player">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Sessions List -->
                <div class="bg-gray-800/50 rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4">üö™ √öltimas Sesiones</h3>
                    <div id="recent-sessions" class="space-y-2 max-h-48 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Live Events Feed -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-rss text-red-400 mr-3 live-indicator"></i>
                Eventos en Vivo (‚ö° cada 1s)
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Recent Events -->
                <div class="bg-gray-800/50 rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-bolt text-yellow-400 mr-2"></i>
                        Actividad Reciente
                    </h3>
                    <div id="events-feed" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Esperando eventos...</p>
                    </div>
                </div>
                
                <!-- Chat -->
                <div class="bg-gray-800/50 rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-comments text-blue-400 mr-2"></i>
                        Chat del Servidor
                    </h3>
                    <div id="chat-feed" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando mensajes...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- All Players -->
        <section>
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-users text-green-400 mr-3"></i>
                Todos los Jugadores
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <a th:each="player : ${stats.players}" 
                   th:href="@{/player/{uuid}(uuid=${player.uuid})}"
                   class="bg-gray-800/50 rounded-lg p-4 card-hover flex items-center space-x-4 hover:bg-gray-700/50 transition-colors">
                    <img th:src="'https://mc-heads.net/avatar/' + ${player.uuid} + '/64'" 
                         alt="Player Head" class="w-12 h-12 rounded">
                    <div class="flex-1">
                        <h3 class="font-bold" th:text="${player.name}">Player</h3>
                        <p class="text-sm text-gray-400">
                            <i class="fas fa-clock mr-1"></i>
                            <span th:text="${player.summary.playTimeFormatted}">0h</span>
                            <span class="mx-2">‚Ä¢</span>
                            <i class="fas fa-cubes mr-1"></i>
                            <span th:text="${#numbers.formatInteger(player.summary.totalBlocksMined, 1, 'COMMA')}">0</span> bloques
                        </p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-500"></i>
                </a>
            </div>
        </section>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>
                <i class="fas fa-code mr-2"></i>
                Minecraft Stats Web - Powered by Spring Boot & Kotlin
                <span class="mx-2">|</span>
                <i class="fas fa-plug mr-1"></i>
                <span id="ws-status">WebSocket: Desconectado</span>
            </p>
        </footer>
    </div>

    <!-- WebSocket JavaScript -->
    <script>
        let stompClient = null;
        
        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;
            
            stompClient.connect({}, function(frame) {
                updateConnectionStatus(true);
                
                // Subscribe to server time (every 5 seconds)
                stompClient.subscribe('/topic/time', function(message) {
                    const update = JSON.parse(message.body);
                    updateServerTime(update.serverTime);
                });
                
                // Subscribe to server status
                stompClient.subscribe('/topic/status', function(message) {
                    const update = JSON.parse(message.body);
                    updateServerStatus(update.data);
                });
                
                // Subscribe to events
                stompClient.subscribe('/topic/events', function(message) {
                    const update = JSON.parse(message.body);
                    addEvent(update.data, update.serverTime);
                });
                
                // Subscribe to player times (for real-time counters)
                stompClient.subscribe('/topic/player-times', function(message) {
                    const update = JSON.parse(message.body);
                    updatePlayerTimes(update.data);
                });
                
                // Subscribe to stats updates
                stompClient.subscribe('/topic/stats', function(message) {
                    const update = JSON.parse(message.body);
                    updateStats(update.data);
                });
                
                loadInitialData();
                
            }, function(error) {
                updateConnectionStatus(false);
                setTimeout(connect, 5000);
            });
        }
        
        function updateServerTime(serverTime) {
            document.getElementById('server-time').textContent = serverTime.time;
            document.getElementById('server-date').textContent = `${serverTime.dayOfWeek}, ${serverTime.date}`;
            document.getElementById('last-update').textContent = serverTime.time;
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            const wsStatus = document.getElementById('ws-status');
            if (connected) {
                statusEl.innerHTML = '<span class="w-3 h-3 bg-green-500 rounded-full mr-2 live-indicator"></span>En vivo';
                wsStatus.textContent = 'WebSocket: Conectado';
            } else {
                statusEl.innerHTML = '<span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>Desconectado';
                wsStatus.textContent = 'WebSocket: Desconectado';
            }
        }
        
        function updateServerStatus(status) {
            document.getElementById('player-count').textContent = status.playerCount;
            document.getElementById('max-players').textContent = status.maxPlayers;
            
            const playersList = document.getElementById('online-players-list');
            playersList.innerHTML = status.onlinePlayers.map(p => 
                `<span class="bg-green-600/30 text-green-300 px-3 py-1 rounded-full text-sm">
                    <i class="fas fa-circle text-green-400 text-xs mr-1"></i>${p.name}
                </span>`
            ).join('');
            
            if (status.lastUpdatedFormatted) {
                document.getElementById('last-update').textContent = status.lastUpdatedFormatted;
            }
        }
        
        function updatePlayerTimes(players) {
            players.forEach(p => {
                const el = document.getElementById(`player-time-${p.uuid}`);
                if (el) {
                    el.textContent = p.playTimeFormatted;
                    if (p.isOnline) {
                        el.classList.add('text-green-400');
                    }
                }
            });
        }
        
        function updateStats(data) {
            if (data.serverTotals) {
                const t = data.serverTotals;
                updateStatValue('total-blocks', t.totalBlocksMined);
                updateStatValue('total-crafted', t.totalItemsCrafted);
                updateStatValue('total-mobs', t.totalMobsKilled);
                updateStatValue('total-deaths', t.totalDeaths);
                updateStatValue('total-damage', t.totalDamageDealt);
            }
        }
        
        function updateStatValue(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value.toLocaleString();
        }
        
        function addEvent(event, serverTime) {
            const feed = document.getElementById('events-feed');
            const firstChild = feed.firstElementChild;
            if (firstChild && firstChild.textContent.includes('Esperando')) {
                feed.innerHTML = '';
            }
            
            let icon, color;
            switch(event.type) {
                case 'JOIN': icon = 'sign-in-alt'; color = 'green'; break;
                case 'LEAVE': icon = 'sign-out-alt'; color = 'red'; break;
                case 'DEATH': icon = 'skull'; color = 'pink'; break;
                case 'ADVANCEMENT': icon = 'trophy'; color = 'yellow'; break;
                case 'CHAT': icon = 'comment'; color = 'blue'; break;
                default: icon = 'info-circle'; color = 'gray';
            }
            
            const dateTime = event.fullDateTime || event.timestamp;
            const eventHtml = `
                <div class="flex items-start space-x-2 py-1 event-enter border-b border-gray-700/50 last:border-0">
                    <span class="text-${color}-400 w-5"><i class="fas fa-${icon}"></i></span>
                    <span class="text-gray-500 text-xs whitespace-nowrap">${dateTime}</span>
                    <span class="text-sm flex-1">${event.message}</span>
                </div>
            `;
            
            feed.insertAdjacentHTML('afterbegin', eventHtml);
            
            // Keep only last 20 events
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }
        
        function addChatMessage(event) {
            const feed = document.getElementById('chat-feed');
            const firstChild = feed.firstElementChild;
            if (firstChild && firstChild.textContent.includes('Cargando')) {
                feed.innerHTML = '';
            }
            
            const dateTime = event.fullDateTime || event.timestamp;
            const chatHtml = `
                <div class="py-1 event-enter border-b border-gray-700/50 last:border-0">
                    <span class="text-gray-500 text-xs">${dateTime}</span>
                    <span class="text-green-400 font-bold">&lt;${event.playerName}&gt;</span>
                    <span class="text-sm">${event.message}</span>
                </div>
            `;
            
            feed.insertAdjacentHTML('afterbegin', chatHtml);
            
            while (feed.children.length > 30) {
                feed.removeChild(feed.lastChild);
            }
        }
        
        async function loadInitialData() {
            try {
                // Load server status
                const statusRes = await fetch('/api/status');
                const status = await statusRes.json();
                updateServerStatus(status);
                
                // Load recent events
                const eventsRes = await fetch('/api/events?limit=20');
                const events = await eventsRes.json();
                events.reverse().forEach(e => addEvent(e, null));
                
                // Load recent chat
                const chatRes = await fetch('/api/chat?limit=20');
                const chat = await chatRes.json();
                chat.reverse().forEach(addChatMessage);
                
                // Load new data (await each to ensure proper execution)
                await loadItemStats();
                await loadRecords();
                await loadActivityStats();
                await loadSessionStats();
                
            } catch (e) {
                console.error('Error loading initial data:', e);
            }
        }
        
        // Load Item Statistics
        async function loadItemStats() {
            try {
                const [mined, used, crafted, killed, killedBy, pickedUp] = await Promise.all([
                    fetch('/api/items/mined?limit=10').then(r => r.json()),
                    fetch('/api/items/used?limit=10').then(r => r.json()),
                    fetch('/api/items/crafted?limit=10').then(r => r.json()),
                    fetch('/api/items/killed?limit=10').then(r => r.json()),
                    fetch('/api/items/killed_by?limit=10').then(r => r.json()),
                    fetch('/api/items/picked_up?limit=10').then(r => r.json())
                ]);
                
                renderItemList('top-mined', mined.entries, '‚õèÔ∏è');
                renderItemList('top-used', used.entries, 'üñ±Ô∏è');
                renderItemList('top-crafted', crafted.entries, 'üî®');
                renderItemList('top-killed', killed.entries, 'üíÄ');
                renderItemList('top-killed-by', killedBy.entries, '‚ò†Ô∏è');
                renderItemList('top-picked-up', pickedUp.entries, 'ü§≤');
            } catch (e) {
                console.error('Error loading item stats:', e);
            }
        }
        
        function renderItemList(containerId, items, emoji) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Sin datos</p>';
                return;
            }
            
            container.innerHTML = items.map((item, i) => `
                <div class="flex justify-between items-center py-1 ${i < items.length - 1 ? 'border-b border-gray-700/30' : ''}">
                    <span class="text-sm truncate flex-1" title="${item.itemId}">
                        ${i < 3 ? ['ü•á', 'ü•à', 'ü•â'][i] : `${i+1}.`} ${item.itemName}
                    </span>
                    <span class="text-green-400 font-mono text-sm ml-2">${item.count.toLocaleString()}</span>
                </div>
            `).join('');
        }
        
        // Load Records
        async function loadRecords() {
            try {
                const records = await fetch('/api/records').then(r => r.json());
                const container = document.getElementById('records-container');
                
                const recordsList = [
                    { data: records.mostDiamondsMined, icon: 'üíé', color: 'cyan' },
                    { data: records.longestBoatDistance, icon: '‚õµ', color: 'blue' },
                    { data: records.mostMobsKilled, icon: '‚öîÔ∏è', color: 'red' },
                    { data: records.longestPlayTime, icon: '‚è±Ô∏è', color: 'purple' },
                    { data: records.mostBlocksMined, icon: '‚õèÔ∏è', color: 'gray' },
                    { data: records.mostItemsCrafted, icon: 'üî®', color: 'orange' },
                    { data: records.mostDeaths, icon: 'üíÄ', color: 'pink' },
                    { data: records.mostFishCaught, icon: 'üêü', color: 'blue' },
                    { data: records.mostVillagerTrades, icon: 'üßë‚Äçüåæ', color: 'green' },
                    { data: records.mostJumps, icon: 'ü¶ò', color: 'yellow' }
                ].filter(r => r.data);
                
                if (recordsList.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Sin records a√∫n</p>';
                    return;
                }
                
                container.innerHTML = recordsList.map(r => `
                    <div class="bg-gray-700/50 rounded-lg p-4 text-center card-hover">
                        <div class="text-2xl mb-2">${r.icon}</div>
                        <p class="text-${r.color}-400 font-bold text-lg">${r.data.formattedValue}</p>
                        <p class="text-xs text-gray-400">${r.data.recordName}</p>
                        <p class="text-sm text-white mt-1">${r.data.playerName}</p>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading records:', e);
            }
        }
        
        // Load Activity Stats
        async function loadActivityStats() {
            try {
                const activity = await fetch('/api/activity?days=30').then(r => r.json());
                
                document.getElementById('most-active-hour').textContent = `${activity.mostActiveHour}:00`;
                document.getElementById('most-active-day').textContent = activity.mostActiveDay;
                document.getElementById('peak-players').textContent = activity.peakPlayers;
                document.getElementById('peak-players-date').textContent = activity.peakPlayersDate;
                
                // Render hourly chart
                renderHourlyChart(activity.hourlyActivity);
            } catch (e) {
                console.error('Error loading activity stats:', e);
            }
        }
        
        function renderHourlyChart(hourlyData) {
            const container = document.getElementById('hourly-chart');
            const maxValue = Math.max(...Object.values(hourlyData), 1);
            
            // Sort by hour (0-23)
            const sortedEntries = Object.entries(hourlyData).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            container.innerHTML = sortedEntries.map(([hour, count]) => {
                const heightPx = Math.max(Math.round((count / maxValue) * 128), 2); // 128px = h-32
                const color = count === maxValue ? 'bg-yellow-400' : 'bg-green-500';
                return `
                    <div class="flex-1 flex flex-col items-center justify-end h-full" title="${hour}:00 - ${count} eventos">
                        <div class="${color} w-full rounded-t transition-all duration-300" style="height: ${heightPx}px"></div>
                    </div>
                `;
            }).join('');
        }
        
        // Load Session Stats
        async function loadSessionStats() {
            try {
                const [sessions, activity] = await Promise.all([
                    fetch('/api/sessions?days=30').then(r => r.json()),
                    fetch('/api/activity?days=30').then(r => r.json())
                ]);
                
                document.getElementById('total-sessions').textContent = sessions.totalSessions;
                document.getElementById('avg-session').textContent = sessions.averageSessionFormatted;
                
                if (sessions.longestSession) {
                    document.getElementById('longest-session').textContent = sessions.longestSession.durationFormatted;
                    document.getElementById('longest-session-player').textContent = sessions.longestSession.playerName;
                }
                
                // Render recent sessions
                const container = document.getElementById('recent-sessions');
                if (sessions.recentSessions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Sin sesiones recientes</p>';
                    return;
                }
                
                container.innerHTML = sessions.recentSessions.slice(0, 10).map(s => `
                    <div class="flex justify-between items-center py-1 border-b border-gray-700/30 text-sm">
                        <span class="text-white">${s.playerName}</span>
                        <span class="text-gray-400 text-xs">${s.joinTime}</span>
                        <span class="${s.durationFormatted === 'En l√≠nea' ? 'text-green-400' : 'text-purple-400'} font-mono">
                            ${s.durationFormatted || '-'}
                        </span>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading session stats:', e);
            }
        }
        
        // Connect on page load
        connect();
    </script>
</body>
</html>
