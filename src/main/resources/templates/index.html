<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${serverName} + ' - Estad√≠sticas'">Minecraft Stats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .minecraft-font { font-family: 'Courier New', monospace; }
        .card-hover:hover { transform: translateY(-2px); transition: transform 0.2s; }
        .gradient-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); }
        .live-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .event-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .stat-update { animation: statPulse 0.5s ease-out; }
        @keyframes statPulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); color: #22c55e; } 100% { transform: scale(1); } }
        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .custom-scroll { scrollbar-width: thin; scrollbar-color: #4b5563 transparent; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold minecraft-font mb-4">
                <i class="fas fa-cube text-green-500 mr-3"></i>
                <span id="server-name" th:text="${serverName}">Server Stats</span>
            </h1>
            <div class="flex justify-center items-center flex-wrap gap-4 text-gray-400">
                <span id="connection-status" class="flex items-center">
                    <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                    Conectando...
                </span>
                <span>‚Ä¢</span>
                <span class="flex items-center">
                    <i class="fas fa-calendar mr-2"></i>
                    <span id="server-date">-</span>
                </span>
                <span>‚Ä¢</span>
                <span class="flex items-center text-xl font-mono text-green-400">
                    <i class="fas fa-clock mr-2"></i>
                    <span id="server-time" class="live-indicator">--:--:--</span>
                </span>
                <span>‚Ä¢</span>
                <span class="text-xs">
                    Actualizado: <span id="last-update">-</span>
                </span>
            </div>
        </header>

        <!-- Live Status Bar -->
        <section class="mb-8">
            <div class="bg-gray-800/70 rounded-lg p-4 flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <div id="server-status" class="flex items-center">
                        <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                        <span class="font-bold">Conectando...</span>
                    </div>
                    <div class="text-gray-400">|</div>
                    <div id="online-players-count" class="flex items-center">
                        <i class="fas fa-users text-green-400 mr-2"></i>
                        <span id="player-count">-</span>/<span id="max-players">-</span> jugadores
                    </div>
                </div>
                <div id="online-players-list" class="flex flex-wrap gap-2">
                    <span class="text-gray-500 text-sm">Cargando...</span>
                </div>
            </div>
        </section>

        <!-- Server Totals - 100% Dynamic -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-server text-blue-400 mr-3"></i>
                Totales del Servidor
                <span class="ml-3 text-xs text-green-400 live-indicator">‚óè EN VIVO</span>
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-users text-3xl text-green-400 mb-2"></i>
                    <p class="text-2xl font-bold" id="stat-total-players">-</p>
                    <p class="text-gray-400 text-sm">Jugadores</p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-cubes text-3xl text-yellow-400 mb-2"></i>
                    <p class="text-2xl font-bold" id="stat-total-blocks">-</p>
                    <p class="text-gray-400 text-sm">Bloques Minados</p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-hammer text-3xl text-orange-400 mb-2"></i>
                    <p class="text-2xl font-bold" id="stat-total-crafted">-</p>
                    <p class="text-gray-400 text-sm">Items Crafteados</p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-skull text-3xl text-red-400 mb-2"></i>
                    <p class="text-2xl font-bold" id="stat-total-mobs">-</p>
                    <p class="text-gray-400 text-sm">Mobs Eliminados</p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-heart-crack text-3xl text-pink-400 mb-2"></i>
                    <p class="text-2xl font-bold" id="stat-total-deaths">-</p>
                    <p class="text-gray-400 text-sm">Muertes Totales</p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-hourglass-half text-3xl text-purple-400 mb-2"></i>
                    <p class="text-2xl font-bold" id="stat-total-playtime">-</p>
                    <p class="text-gray-400 text-sm">Tiempo Jugado</p>
                </div>
            </div>
        </section>

        <!-- Leaderboards - 100% Dynamic -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-trophy text-yellow-400 mr-3"></i>
                Leaderboards
                <span class="ml-3 text-xs text-green-400 live-indicator">‚óè EN VIVO</span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Most Blocks Mined -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-gem text-yellow-400 mr-2"></i>
                        ‚õèÔ∏è M√°s Bloques Minados
                    </h3>
                    <ul id="lb-blocks" class="space-y-2">
                        <li class="text-gray-500 text-sm">Cargando...</li>
                    </ul>
                </div>

                <!-- Most Mobs Killed -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-skull-crossbones text-red-400 mr-2"></i>
                        ‚öîÔ∏è M√°s Mobs Eliminados
                    </h3>
                    <ul id="lb-mobs" class="space-y-2">
                        <li class="text-gray-500 text-sm">Cargando...</li>
                    </ul>
                </div>

                <!-- Most Play Time -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-clock text-purple-400 mr-2"></i>
                        ‚è±Ô∏è M√°s Tiempo Jugado
                    </h3>
                    <ul id="lb-playtime" class="space-y-2">
                        <li class="text-gray-500 text-sm">Cargando...</li>
                    </ul>
                </div>

                <!-- Most Deaths -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-heart-crack text-pink-400 mr-2"></i>
                        üíÄ M√°s Muertes
                    </h3>
                    <ul id="lb-deaths" class="space-y-2">
                        <li class="text-gray-500 text-sm">Cargando...</li>
                    </ul>
                </div>

                <!-- Most Distance Walked -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-person-walking text-blue-400 mr-2"></i>
                        üö∂ M√°s Distancia
                    </h3>
                    <ul id="lb-distance" class="space-y-2">
                        <li class="text-gray-500 text-sm">Cargando...</li>
                    </ul>
                </div>

                <!-- Most Items Crafted -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-hammer text-orange-400 mr-2"></i>
                        üî® M√°s Crafteados
                    </h3>
                    <ul id="lb-crafted" class="space-y-2">
                        <li class="text-gray-500 text-sm">Cargando...</li>
                    </ul>
                </div>

                <!-- Most Damage Dealt -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-bolt text-red-500 mr-2"></i>
                        üí• M√°s Da√±o Infligido
                    </h3>
                    <ul id="lb-damage" class="space-y-2">
                        <li class="text-gray-500 text-sm">Cargando...</li>
                    </ul>
                </div>

                <!-- Most Jumps -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-arrow-up text-green-400 mr-2"></i>
                        ü¶ò M√°s Saltos
                    </h3>
                    <ul id="lb-jumps" class="space-y-2">
                        <li class="text-gray-500 text-sm">Cargando...</li>
                    </ul>
                </div>

                <!-- Most Fish Caught -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-fish text-cyan-400 mr-2"></i>
                        üêü M√°s Peces Pescados
                    </h3>
                    <ul id="lb-fish" class="space-y-2">
                        <li class="text-gray-500 text-sm">Cargando...</li>
                    </ul>
                </div>

                <!-- Most Villager Trades -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-handshake text-emerald-400 mr-2"></i>
                        ü§ù M√°s Comercios
                    </h3>
                    <ul id="lb-trades" class="space-y-2">
                        <li class="text-gray-500 text-sm">Cargando...</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Detailed Server Stats - 100% Dynamic -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-chart-bar text-purple-400 mr-3"></i>
                Estad√≠sticas Detalladas del Servidor
                <span class="ml-3 text-xs text-green-400 live-indicator">‚óè EN VIVO</span>
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                <!-- Total Damage Dealt -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-sword text-red-400 text-2xl mb-2"></i>
                    <p class="text-xl font-bold text-red-400" id="stat-damage">-</p>
                    <p class="text-xs text-gray-400">Da√±o Infligido</p>
                </div>
                <!-- Total Distance -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-route text-blue-400 text-2xl mb-2"></i>
                    <p class="text-xl font-bold text-blue-400" id="stat-distance">-</p>
                    <p class="text-xs text-gray-400">Distancia Total</p>
                </div>
                <!-- Chests Opened -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-box-open text-yellow-400 text-2xl mb-2"></i>
                    <p class="text-xl font-bold text-yellow-400" id="stat-chests">-</p>
                    <p class="text-xs text-gray-400">Cofres Abiertos</p>
                </div>
                <!-- Jumps -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-arrow-up text-green-400 text-2xl mb-2"></i>
                    <p class="text-xl font-bold text-green-400" id="stat-jumps">-</p>
                    <p class="text-xs text-gray-400">Saltos</p>
                </div>
                <!-- Fish Caught -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-fish text-cyan-400 text-2xl mb-2"></i>
                    <p class="text-xl font-bold text-cyan-400" id="stat-fish">-</p>
                    <p class="text-xs text-gray-400">Peces Pescados</p>
                </div>
                <!-- Animals Bred -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-heart text-pink-400 text-2xl mb-2"></i>
                    <p class="text-xl font-bold text-pink-400" id="stat-bred">-</p>
                    <p class="text-xs text-gray-400">Animales Criados</p>
                </div>
                <!-- Villager Trades -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-handshake text-emerald-400 text-2xl mb-2"></i>
                    <p class="text-xl font-bold text-emerald-400" id="stat-trades">-</p>
                    <p class="text-xs text-gray-400">Comercios</p>
                </div>
                <!-- Times Slept -->
                <div class="bg-gray-800/50 rounded-lg p-4 text-center card-hover">
                    <i class="fas fa-bed text-indigo-400 text-2xl mb-2"></i>
                    <p class="text-xl font-bold text-indigo-400" id="stat-sleep">-</p>
                    <p class="text-xs text-gray-400">Veces Dormido</p>
                </div>
            </div>
        </section>

        <!-- Player Detailed Stats - 100% Dynamic -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-user-chart text-cyan-400 mr-3"></i>
                Estad√≠sticas por Jugador
                <span class="ml-3 text-xs text-green-400 live-indicator">‚óè EN VIVO</span>
            </h2>
            <div id="players-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-gray-800/50 rounded-lg p-6 text-center">
                    <p class="text-gray-500">Cargando jugadores...</p>
                </div>
            </div>
        </section>

        <!-- Server Records -->
        <section class="mb-12" id="records-section">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-trophy text-yellow-400 mr-3"></i>
                üèÜ Records del Servidor
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4" id="records-container">
                <p class="text-gray-500">Cargando records...</p>
            </div>
        </section>

        <!-- Diamond Statistics Section -->
        <section class="mb-12" id="diamond-section">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <span class="text-3xl mr-3">üíé</span>
                Estad√≠sticas de Diamantes
                <span class="ml-2 text-xs text-green-400 animate-pulse">‚óè EN VIVO</span>
            </h2>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-cyan-900/50 to-cyan-700/30 rounded-lg p-4 text-center card-hover">
                    <div class="text-3xl mb-2">‚õèÔ∏è</div>
                    <p class="text-cyan-400 font-bold text-2xl" id="diamond-total-mined">-</p>
                    <p class="text-xs text-gray-400">Total Minados</p>
                </div>
                <div class="bg-gradient-to-br from-blue-900/50 to-blue-700/30 rounded-lg p-4 text-center card-hover">
                    <div class="text-3xl mb-2">üíé</div>
                    <p class="text-blue-400 font-bold text-2xl" id="diamond-picked-up">-</p>
                    <p class="text-xs text-gray-400">Recogidos</p>
                </div>
                <div class="bg-gradient-to-br from-purple-900/50 to-purple-700/30 rounded-lg p-4 text-center card-hover">
                    <div class="text-3xl mb-2">üî®</div>
                    <p class="text-purple-400 font-bold text-2xl" id="diamond-tools-crafted">-</p>
                    <p class="text-xs text-gray-400">Herramientas</p>
                </div>
                <div class="bg-gradient-to-br from-red-900/50 to-red-700/30 rounded-lg p-4 text-center card-hover">
                    <div class="text-3xl mb-2">üíî</div>
                    <p class="text-red-400 font-bold text-2xl" id="diamond-tools-broken">-</p>
                    <p class="text-xs text-gray-400">Rotas</p>
                </div>
            </div>

            <!-- Mining Breakdown + Leaderboard -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Mining Breakdown -->
                <div class="bg-gray-800/50 rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4 text-cyan-400">‚õèÔ∏è Desglose de Miner√≠a</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Diamond Ore (Normal)</span>
                            <span class="text-cyan-400 font-mono" id="diamond-ore-normal">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Deepslate Diamond Ore</span>
                            <span class="text-cyan-400 font-mono" id="diamond-ore-deepslate">-</span>
                        </div>
                        <div class="border-t border-gray-700 pt-2 flex justify-between items-center">
                            <span class="text-white font-bold">Total</span>
                            <span class="text-cyan-400 font-mono font-bold" id="diamond-ore-total">-</span>
                        </div>
                    </div>
                    <!-- Diamond Flow -->
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <h4 class="text-sm font-bold mb-2 text-gray-400">üìä Flujo de Diamantes</h4>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-green-400">+<span id="diamond-flow-in">0</span> recogidos</span>
                            <span class="text-red-400">-<span id="diamond-flow-out">0</span> soltados</span>
                            <span class="text-cyan-400 font-bold">=<span id="diamond-flow-net">0</span> neto</span>
                        </div>
                    </div>
                </div>

                <!-- Leaderboard Top 5 -->
                <div class="bg-gray-800/50 rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-4 text-yellow-400">üèÜ Top Mineros de Diamantes</h3>
                    <div class="space-y-2" id="diamond-leaderboard">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Item Statistics -->
        <section class="mb-12" id="items-section">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-box text-orange-400 mr-3"></i>
                üì¶ Estad√≠sticas de Items
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Top Mined -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-pickaxe text-gray-400 mr-2"></i>
                        ‚õèÔ∏è Bloques M√°s Minados
                    </h3>
                    <div id="top-mined" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
                
                <!-- Top Used -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-hand-pointer text-blue-400 mr-2"></i>
                        üñ±Ô∏è Items M√°s Usados
                    </h3>
                    <div id="top-used" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
                
                <!-- Top Crafted -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-hammer text-orange-400 mr-2"></i>
                        üî® Items M√°s Crafteados
                    </h3>
                    <div id="top-crafted" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
                
                <!-- Top Killed Mobs -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-skull text-red-400 mr-2"></i>
                        üíÄ Mobs M√°s Eliminados
                    </h3>
                    <div id="top-killed" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
                
                <!-- Deaths by Mob -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-skull-crossbones text-pink-400 mr-2"></i>
                        ‚ò†Ô∏è Muertes por Mob
                    </h3>
                    <div id="top-killed-by" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
                
                <!-- Top Picked Up -->
                <div class="bg-gray-800/50 rounded-lg p-6 card-hover">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-hand-holding text-green-400 mr-2"></i>
                        ü§≤ Items M√°s Recogidos
                    </h3>
                    <div id="top-picked-up" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Activity Analysis -->
        <section class="mb-12" id="activity-section">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-chart-line text-cyan-400 mr-3"></i>
                üìà An√°lisis de Actividad (30 d√≠as)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Most Active Hour -->
                <div class="bg-gray-800/50 rounded-lg p-6 text-center card-hover">
                    <i class="fas fa-clock text-yellow-400 text-3xl mb-3"></i>
                    <p class="text-3xl font-bold text-yellow-400" id="most-active-hour">--:00</p>
                    <p class="text-sm text-gray-400">Hora M√°s Activa</p>
                </div>
                
                <!-- Most Active Day -->
                <div class="bg-gray-800/50 rounded-lg p-6 text-center card-hover">
                    <i class="fas fa-calendar-day text-green-400 text-3xl mb-3"></i>
                    <p class="text-2xl font-bold text-green-400" id="most-active-day">-</p>
                    <p class="text-sm text-gray-400">D√≠a M√°s Activo</p>
                </div>
                
                <!-- Peak Players -->
                <div class="bg-gray-800/50 rounded-lg p-6 text-center card-hover">
                    <i class="fas fa-users text-blue-400 text-3xl mb-3"></i>
                    <p class="text-3xl font-bold text-blue-400" id="peak-players">0</p>
                    <p class="text-sm text-gray-400">Pico de Jugadores</p>
                    <p class="text-xs text-gray-500" id="peak-players-date">-</p>
                </div>
                
                <!-- Total Sessions -->
                <div class="bg-gray-800/50 rounded-lg p-6 text-center card-hover">
                    <i class="fas fa-door-open text-purple-400 text-3xl mb-3"></i>
                    <p class="text-3xl font-bold text-purple-400" id="total-sessions">0</p>
                    <p class="text-sm text-gray-400">Sesiones Totales</p>
                </div>
            </div>
            
            <!-- Hourly Activity Chart (Simple) -->
            <div class="bg-gray-800/50 rounded-lg p-6 mt-6">
                <h3 class="text-lg font-bold mb-4">‚è∞ Actividad por Hora</h3>
                <div id="hourly-chart" class="flex items-end justify-between h-32 gap-1">
                    <!-- Generated by JS -->
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-2">
                    <span>00:00</span>
                    <span>06:00</span>
                    <span>12:00</span>
                    <span>18:00</span>
                    <span>23:00</span>
                </div>
            </div>
        </section>

        <!-- Recent Sessions -->
        <section class="mb-12" id="sessions-section">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-history text-purple-400 mr-3"></i>
                üïê Sesiones Recientes
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Session Stats -->
                <div class="bg-gray-800/50 rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4">üìä Estad√≠sticas de Sesiones</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Sesi√≥n promedio:</span>
                            <span class="text-green-400 font-mono" id="avg-session">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Sesi√≥n m√°s larga:</span>
                            <span class="text-yellow-400 font-mono" id="longest-session">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Por:</span>
                            <span class="text-yellow-400" id="longest-session-player">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Sessions List -->
                <div class="bg-gray-800/50 rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4">üö™ √öltimas Sesiones</h3>
                    <div id="recent-sessions" class="space-y-2 max-h-48 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Live Events Feed -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-rss text-red-400 mr-3 live-indicator"></i>
                Eventos en Vivo (‚ö° cada 1s)
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Recent Events -->
                <div class="bg-gray-800/50 rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-bolt text-yellow-400 mr-2"></i>
                        Actividad Reciente
                    </h3>
                    <div id="events-feed" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Esperando eventos...</p>
                    </div>
                </div>
                
                <!-- Chat -->
                <div class="bg-gray-800/50 rounded-lg p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-comments text-blue-400 mr-2"></i>
                        Chat del Servidor
                    </h3>
                    <div id="chat-feed" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <p class="text-gray-500 text-sm">Cargando mensajes...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- All Players - 100% Dynamic -->
        <section>
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-users text-green-400 mr-3"></i>
                Todos los Jugadores
                <span class="ml-3 text-xs text-green-400 live-indicator">‚óè EN VIVO</span>
            </h2>
            <div id="all-players-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-gray-800/50 rounded-lg p-4 text-center">
                    <p class="text-gray-500">Cargando jugadores...</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>
                <i class="fas fa-code mr-2"></i>
                Minecraft Stats Web - Powered by Spring Boot & Kotlin
                <span class="mx-2">|</span>
                <i class="fas fa-plug mr-1"></i>
                <span id="ws-status">WebSocket: Desconectado</span>
            </p>
        </footer>
    </div>

    <!-- WebSocket JavaScript - 100% Dynamic -->
    <script>
        let stompClient = null;
        let cachedStats = null;
        let onlinePlayers = new Set();
        
        // ================= WEBSOCKET CONNECTION =================
        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;
            
            stompClient.connect({}, function(frame) {
                updateConnectionStatus(true);
                
                // Subscribe to server time (every 1s)
                stompClient.subscribe('/topic/time', function(message) {
                    const update = JSON.parse(message.body);
                    updateServerTime(update.serverTime);
                });
                
                // Subscribe to server status (every 30s)
                stompClient.subscribe('/topic/status', function(message) {
                    const update = JSON.parse(message.body);
                    updateServerStatus(update.data);
                });
                
                // Subscribe to ALL events
                stompClient.subscribe('/topic/events', function(message) {
                    const update = JSON.parse(message.body);
                    addEvent(update.data, update.serverTime);
                    if (update.type === 'CHAT') {
                        addChatMessage(update.data);
                    }
                });
                
                // Subscribe to chat
                stompClient.subscribe('/topic/chat', function(message) {
                    const update = JSON.parse(message.body);
                    addChatMessage(update.data);
                });
                
                // Subscribe to stats updates (every 30s) - CRITICAL FOR DYNAMIC
                stompClient.subscribe('/topic/stats', function(message) {
                    const update = JSON.parse(message.body);
                    cachedStats = update.data;
                    renderAllStats(update.data);
                });
                
                // Subscribe to item stats
                stompClient.subscribe('/topic/items', function(message) {
                    const update = JSON.parse(message.body);
                    updateItemStats(update.data);
                });

                // Subscribe to diamond stats (real-time every 1 second)
                stompClient.subscribe('/topic/diamonds', function(message) {
                    const update = JSON.parse(message.body);
                    updateDiamondStats(update.data);
                });

                // Subscribe to player times
                stompClient.subscribe('/topic/player-times', function(message) {
                    const update = JSON.parse(message.body);
                    updatePlayerTimes(update.data);
                });
                
                // Load all initial data via API
                loadAllInitialData();
                
            }, function(error) {
                updateConnectionStatus(false);
                setTimeout(connect, 5000);
            });
        }
        
        // ================= INITIAL DATA LOADING =================
        async function loadAllInitialData() {
            try {
                // Load everything in parallel
                const [stats, status, events, chat] = await Promise.all([
                    fetch('/api/stats').then(r => r.json()),
                    fetch('/api/status').then(r => r.json()),
                    fetch('/api/events?limit=20').then(r => r.json()),
                    fetch('/api/chat?limit=20').then(r => r.json())
                ]);
                
                // Cache and render stats
                cachedStats = stats;
                renderAllStats(stats);
                
                // Update server status
                updateServerStatus(status);
                
                // Render events
                events.reverse().forEach(e => addEvent(e, null));
                chat.reverse().forEach(addChatMessage);
                
                // Load additional data
                await Promise.all([
                    loadItemStats(),
                    loadDiamondStats(),
                    loadRecords(),
                    loadActivityStats(),
                    loadSessionStats()
                ]);
                
            } catch (e) {
                console.error('Error loading initial data:', e);
            }
        }
        
        // ================= RENDER ALL STATS (FULLY DYNAMIC) =================
        function renderAllStats(data) {
            if (!data) return;
            
            // Server totals
            animateStat('stat-total-players', data.totalPlayers);
            animateStat('stat-total-blocks', formatNumber(data.serverTotals?.totalBlocksMined || 0));
            animateStat('stat-total-crafted', formatNumber(data.serverTotals?.totalItemsCrafted || 0));
            animateStat('stat-total-mobs', formatNumber(data.serverTotals?.totalMobsKilled || 0));
            animateStat('stat-total-deaths', formatNumber(data.serverTotals?.totalDeaths || 0));
            animateStat('stat-total-playtime', data.serverTotals?.totalPlayTimeFormatted || '-');
            
            // Detailed stats
            animateStat('stat-damage', formatNumber(data.serverTotals?.totalDamageDealt || 0));
            const distKm = ((data.serverTotals?.totalDistanceTraveled || 0) / 100000).toFixed(1);
            animateStat('stat-distance', distKm + ' km');
            animateStat('stat-chests', formatNumber(data.serverTotals?.totalChestsOpened || 0));
            
            // Calculate additional totals from players
            let totalJumps = 0, totalFish = 0, totalBred = 0, totalTrades = 0, totalSleep = 0;
            if (data.players) {
                data.players.forEach(p => {
                    totalJumps += p.summary?.jumps || 0;
                    if (p.detailedStats) {
                        totalFish += p.detailedStats.fishCaught || 0;
                        totalBred += p.detailedStats.animalsBreed || 0;
                        totalTrades += p.detailedStats.villagersTraded || 0;
                        totalSleep += p.detailedStats.timesSlept || 0;
                    }
                });
            }
            animateStat('stat-jumps', formatNumber(totalJumps));
            animateStat('stat-fish', formatNumber(totalFish));
            animateStat('stat-bred', formatNumber(totalBred));
            animateStat('stat-trades', formatNumber(totalTrades));
            animateStat('stat-sleep', formatNumber(totalSleep));
            
            // Leaderboards
            if (data.leaderboards) {
                renderLeaderboard('lb-blocks', data.leaderboards.mostBlocksMined, 'green');
                renderLeaderboard('lb-mobs', data.leaderboards.mostMobsKilled, 'red');
                renderLeaderboard('lb-playtime', data.leaderboards.mostPlayTime, 'purple', true);
                renderLeaderboard('lb-deaths', data.leaderboards.mostDeaths, 'pink');
                renderLeaderboard('lb-distance', data.leaderboards.mostDistanceWalked, 'blue', true);
                renderLeaderboard('lb-crafted', data.leaderboards.mostItemsCrafted, 'orange');
                renderLeaderboard('lb-damage', data.leaderboards.mostDamageDealt, 'red');
                renderLeaderboard('lb-jumps', data.leaderboards.mostJumps, 'green');
                renderLeaderboard('lb-fish', data.leaderboards.mostFishCaught, 'cyan');
                renderLeaderboard('lb-trades', data.leaderboards.mostVillagerTrades, 'emerald');
            }
            
            // Players detailed
            if (data.players) {
                renderPlayersDetailed(data.players);
                renderAllPlayersList(data.players);
            }
        }
        
        // ================= LEADERBOARD RENDERING =================
        function renderLeaderboard(containerId, entries, color, useFormatted = false) {
            const container = document.getElementById(containerId);
            if (!container || !entries || entries.length === 0) {
                if (container) container.innerHTML = '<li class="text-gray-500 text-sm">Sin datos</li>';
                return;
            }
            
            container.innerHTML = entries.map(entry => {
                const rankClass = entry.rank === 1 ? 'text-yellow-400' : 
                                  entry.rank === 2 ? 'text-gray-400' : 
                                  entry.rank === 3 ? 'text-orange-600' : 'text-gray-500';
                const displayValue = useFormatted ? entry.formattedValue : formatNumber(entry.value);
                const isOnline = onlinePlayers.has(entry.playerName);
                
                return `
                    <li class="flex justify-between items-center py-2 border-b border-gray-700 last:border-0">
                        <span class="flex items-center">
                            <span class="${rankClass} w-6 font-bold">#${entry.rank}</span>
                            <a href="/player/${entry.playerUuid}" class="ml-2 hover:text-green-400 transition-colors ${isOnline ? 'text-green-400' : ''}">
                                ${isOnline ? 'üü¢ ' : ''}${entry.playerName}
                            </a>
                        </span>
                        <span class="text-${color}-400 font-mono">${displayValue}</span>
                    </li>
                `;
            }).join('');
        }
        
        // ================= PLAYERS DETAILED RENDERING =================
        function renderPlayersDetailed(players) {
            const container = document.getElementById('players-container');
            if (!container || !players || players.length === 0) return;
            
            container.innerHTML = players.map(player => {
                const isOnline = onlinePlayers.has(player.name);
                const d = player.detailedStats || {};
                const s = player.summary || {};
                
                return `
                    <div class="bg-gray-800/50 rounded-lg p-6 card-hover ${isOnline ? 'ring-2 ring-green-500' : ''}">
                        <div class="flex items-center mb-4">
                            <img src="https://mc-heads.net/avatar/${player.name}/48" class="w-12 h-12 rounded-lg mr-3" alt="Avatar">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg ${isOnline ? 'text-green-400' : ''}">${isOnline ? 'üü¢ ' : ''}${player.name}</h3>
                                <p class="text-sm text-gray-400" id="player-time-${player.uuid}">${s.playTimeFormatted || '-'}</p>
                            </div>
                            ${isOnline ? '<span class="text-xs bg-green-600 px-2 py-1 rounded">EN L√çNEA</span>' : ''}
                        </div>
                        
                        <!-- Combat -->
                        <div class="mb-3">
                            <p class="text-xs text-gray-500 uppercase mb-2">‚öîÔ∏è Combate</p>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Da√±o infligido:</span><span class="text-red-400">${formatNumber(d.damageDealt || 0)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Da√±o recibido:</span><span class="text-orange-400">${formatNumber(d.damageTaken || 0)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Bloqueado:</span><span class="text-blue-400">${formatNumber(d.damageBlocked || 0)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Muertes:</span><span class="text-pink-400">${s.totalDeaths || 0}</span></div>
                            </div>
                        </div>
                        
                        <!-- Movement -->
                        <div class="mb-3">
                            <p class="text-xs text-gray-500 uppercase mb-2">üö∂ Movimiento</p>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Caminando:</span><span class="text-green-400">${formatKm(d.walkDistance)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Sprint:</span><span class="text-green-400">${formatKm(d.sprintDistance)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Barco:</span><span class="text-blue-400">${formatKm(d.boatDistance)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Caballo:</span><span class="text-yellow-400">${formatKm(d.horseDistance)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Nadando:</span><span class="text-cyan-400">${formatKm(d.swimDistance)}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Elytra:</span><span class="text-purple-400">${formatKm(d.elytraDistance)}</span></div>
                            </div>
                        </div>
                        
                        <!-- Interactions -->
                        <div>
                            <p class="text-xs text-gray-500 uppercase mb-2">üéÆ Interacciones</p>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Cofres:</span><span class="text-yellow-400">${d.chestsOpened || 0}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Crafteos:</span><span class="text-orange-400">${d.craftingTableUses || 0}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Hornos:</span><span class="text-red-400">${d.furnaceUses || 0}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Dormido:</span><span class="text-purple-400">${d.timesSlept || 0}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Comercios:</span><span class="text-emerald-400">${d.villagersTraded || 0}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Pesca:</span><span class="text-blue-400">${d.fishCaught || 0}</span></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ================= ALL PLAYERS LIST =================
        function renderAllPlayersList(players) {
            const container = document.getElementById('all-players-list');
            if (!container || !players) return;
            
            container.innerHTML = players.map(player => {
                const isOnline = onlinePlayers.has(player.name);
                const s = player.summary || {};
                
                return `
                    <a href="/player/${player.uuid}" class="bg-gray-800/50 rounded-lg p-4 card-hover flex items-center space-x-4 hover:bg-gray-700/50 transition-colors ${isOnline ? 'ring-2 ring-green-500' : ''}">
                        <img src="https://mc-heads.net/avatar/${player.uuid}/64" alt="Player Head" class="w-12 h-12 rounded">
                        <div class="flex-1">
                            <h3 class="font-bold ${isOnline ? 'text-green-400' : ''}">${isOnline ? 'üü¢ ' : ''}${player.name}</h3>
                            <p class="text-sm text-gray-400">
                                <i class="fas fa-clock mr-1"></i>
                                <span>${s.playTimeFormatted || '-'}</span>
                                <span class="mx-2">‚Ä¢</span>
                                <i class="fas fa-cubes mr-1"></i>
                                <span>${formatNumber(s.totalBlocksMined || 0)}</span> bloques
                            </p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-500"></i>
                    </a>
                `;
            }).join('');
        }
        
        // ================= SERVER TIME & STATUS =================
        function updateServerTime(serverTime) {
            if (!serverTime) return;
            document.getElementById('server-time').textContent = serverTime.time;
            document.getElementById('server-date').textContent = `${serverTime.dayOfWeek}, ${serverTime.date}`;
            document.getElementById('last-update').textContent = serverTime.time;
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            const wsStatus = document.getElementById('ws-status');
            if (connected) {
                statusEl.innerHTML = '<span class="w-3 h-3 bg-green-500 rounded-full mr-2 live-indicator"></span>En vivo';
                wsStatus.textContent = 'WebSocket: Conectado ‚úì';
            } else {
                statusEl.innerHTML = '<span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>Desconectado';
                wsStatus.textContent = 'WebSocket: Desconectado';
            }
        }
        
        function updateServerStatus(status) {
            if (!status) return;
            
            const serverStatusEl = document.getElementById('server-status');
            if (status.online) {
                serverStatusEl.innerHTML = '<span class="w-3 h-3 bg-green-500 rounded-full mr-2 live-indicator"></span><span class="font-bold">Servidor Online</span>';
            } else {
                serverStatusEl.innerHTML = '<span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span><span class="font-bold">Servidor Offline</span>';
            }
            
            document.getElementById('player-count').textContent = status.playerCount;
            document.getElementById('max-players').textContent = status.maxPlayers;
            
            // Update online players set
            onlinePlayers.clear();
            status.onlinePlayers?.forEach(p => onlinePlayers.add(p.name));
            
            const playersList = document.getElementById('online-players-list');
            if (status.onlinePlayers && status.onlinePlayers.length > 0) {
                playersList.innerHTML = status.onlinePlayers.map(p => 
                    `<span class="bg-green-600/30 text-green-300 px-3 py-1 rounded-full text-sm">
                        <i class="fas fa-circle text-green-400 text-xs mr-1"></i>${p.name}
                    </span>`
                ).join('');
            } else {
                playersList.innerHTML = '<span class="text-gray-500 text-sm">Nadie conectado</span>';
            }
            
            // Re-render players if we have cached stats (to update online indicators)
            if (cachedStats) {
                renderPlayersDetailed(cachedStats.players);
                renderAllPlayersList(cachedStats.players);
            }
        }
        
        // ================= PLAYER TIMES UPDATE =================
        function updatePlayerTimes(players) {
            if (!players) return;
            players.forEach(p => {
                const el = document.getElementById(`player-time-${p.uuid}`);
                if (el) {
                    el.textContent = p.playTimeFormatted;
                    if (p.isOnline) el.classList.add('text-green-400');
                }
            });
        }

        // ================= DIAMOND STATS =================
        function updateDiamondStats(data) {
            if (!data) return;

            // Totals
            const totalMined = (data.totalDiamondOreMined || 0) + (data.totalDeepslateDiamondOreMined || 0);
            animateStat('diamond-total-mined', formatNumber(totalMined));
            animateStat('diamond-picked-up', formatNumber(data.totalDiamondsPickedUp || 0));
            animateStat('diamond-tools-crafted', formatNumber((data.toolsCrafted || 0) + (data.armorCrafted || 0)));
            animateStat('diamond-tools-broken', formatNumber(data.toolsBroken || 0));

            // Breakdown
            animateStat('diamond-ore-normal', formatNumber(data.totalDiamondOreMined || 0));
            animateStat('diamond-ore-deepslate', formatNumber(data.totalDeepslateDiamondOreMined || 0));
            animateStat('diamond-ore-total', formatNumber(totalMined));

            // Flow
            const flowIn = data.totalDiamondsPickedUp || 0;
            const flowOut = data.totalDiamondsDropped || 0;
            const flowInEl = document.getElementById('diamond-flow-in');
            const flowOutEl = document.getElementById('diamond-flow-out');
            const flowNetEl = document.getElementById('diamond-flow-net');
            if (flowInEl) flowInEl.textContent = formatNumber(flowIn);
            if (flowOutEl) flowOutEl.textContent = formatNumber(flowOut);
            if (flowNetEl) flowNetEl.textContent = formatNumber(flowIn - flowOut);

            // Leaderboard
            renderDiamondLeaderboard(data.leaderboard || []);
        }

        function renderDiamondLeaderboard(leaderboard) {
            const container = document.getElementById('diamond-leaderboard');
            if (!container) return;

            if (leaderboard.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Sin datos de diamantes</p>';
                return;
            }

            const maxValue = leaderboard[0]?.total || 1;
            const medals = ['ü•á', 'ü•à', 'ü•â', '4.', '5.'];

            container.innerHTML = leaderboard.map((entry, i) => {
                const percentage = (entry.total / maxValue) * 100;
                return `
                    <div class="flex items-center gap-2">
                        <span class="w-6 text-center">${medals[i] || (i+1) + '.'}</span>
                        <span class="flex-1 truncate">${entry.playerName}</span>
                        <div class="w-24 bg-gray-700 rounded-full h-2">
                            <div class="bg-cyan-500 h-2 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                        </div>
                        <span class="text-cyan-400 font-mono w-16 text-right">${formatNumber(entry.total)} üíé</span>
                    </div>
                `;
            }).join('');
        }

        async function loadDiamondStats() {
            try {
                const data = await fetch('/api/diamonds').then(r => r.json());
                updateDiamondStats(data);
            } catch (e) {
                console.error('Error loading diamond stats:', e);
            }
        }

        // ================= ITEM STATS =================
        function updateItemStats(items) {
            if (!items) return;
            if (items.mined) renderItemList('top-mined', items.mined.entries, '‚õèÔ∏è');
            if (items.used) renderItemList('top-used', items.used.entries, 'üñ±Ô∏è');
            if (items.crafted) renderItemList('top-crafted', items.crafted.entries, 'üî®');
            if (items.killed) renderItemList('top-killed', items.killed.entries, 'üíÄ');
            if (items.killed_by) renderItemList('top-killed-by', items.killed_by.entries, '‚ò†Ô∏è');
            if (items.picked_up) renderItemList('top-picked-up', items.picked_up.entries, 'ü§≤');
        }
        
        async function loadItemStats() {
            try {
                const [mined, used, crafted, killed, killedBy, pickedUp] = await Promise.all([
                    fetch('/api/items/mined?limit=10').then(r => r.json()),
                    fetch('/api/items/used?limit=10').then(r => r.json()),
                    fetch('/api/items/crafted?limit=10').then(r => r.json()),
                    fetch('/api/items/killed?limit=10').then(r => r.json()),
                    fetch('/api/items/killed_by?limit=10').then(r => r.json()),
                    fetch('/api/items/picked_up?limit=10').then(r => r.json())
                ]);
                
                renderItemList('top-mined', mined.entries, '‚õèÔ∏è');
                renderItemList('top-used', used.entries, 'üñ±Ô∏è');
                renderItemList('top-crafted', crafted.entries, 'üî®');
                renderItemList('top-killed', killed.entries, 'üíÄ');
                renderItemList('top-killed-by', killedBy.entries, '‚ò†Ô∏è');
                renderItemList('top-picked-up', pickedUp.entries, 'ü§≤');
            } catch (e) {
                console.error('Error loading item stats:', e);
            }
        }
        
        function renderItemList(containerId, items, emoji) {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Sin datos</p>';
                return;
            }
            
            container.innerHTML = items.map((item, i) => `
                <div class="flex justify-between items-center py-1 ${i < items.length - 1 ? 'border-b border-gray-700/30' : ''}">
                    <span class="text-sm truncate flex-1" title="${item.itemId}">
                        ${i < 3 ? ['ü•á', 'ü•à', 'ü•â'][i] : `${i+1}.`} ${item.itemName}
                    </span>
                    <span class="text-green-400 font-mono text-sm ml-2">${formatNumber(item.count)}</span>
                </div>
            `).join('');
        }
        
        // ================= RECORDS =================
        async function loadRecords() {
            try {
                const records = await fetch('/api/records').then(r => r.json());
                const container = document.getElementById('records-container');
                if (!container) return;
                
                const recordsList = [
                    { data: records.mostDiamondsMined, icon: 'üíé', color: 'cyan' },
                    { data: records.longestBoatDistance, icon: '‚õµ', color: 'blue' },
                    { data: records.mostMobsKilled, icon: '‚öîÔ∏è', color: 'red' },
                    { data: records.longestPlayTime, icon: '‚è±Ô∏è', color: 'purple' },
                    { data: records.mostBlocksMined, icon: '‚õèÔ∏è', color: 'gray' },
                    { data: records.mostItemsCrafted, icon: 'üî®', color: 'orange' },
                    { data: records.mostDeaths, icon: 'üíÄ', color: 'pink' },
                    { data: records.mostFishCaught, icon: 'üêü', color: 'blue' },
                    { data: records.mostVillagerTrades, icon: 'üßë‚Äçüåæ', color: 'green' },
                    { data: records.mostJumps, icon: 'ü¶ò', color: 'yellow' }
                ].filter(r => r.data);
                
                if (recordsList.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Sin records a√∫n</p>';
                    return;
                }
                
                container.innerHTML = recordsList.map(r => `
                    <div class="bg-gray-700/50 rounded-lg p-4 text-center card-hover">
                        <div class="text-2xl mb-2">${r.icon}</div>
                        <p class="text-${r.color}-400 font-bold text-lg">${r.data.formattedValue}</p>
                        <p class="text-xs text-gray-400">${r.data.recordName}</p>
                        <p class="text-sm text-white mt-1">${r.data.playerName}</p>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading records:', e);
            }
        }
        
        // ================= ACTIVITY STATS =================
        async function loadActivityStats() {
            try {
                const activity = await fetch('/api/activity?days=30').then(r => r.json());
                
                const el = (id) => document.getElementById(id);
                if (el('most-active-hour')) el('most-active-hour').textContent = `${activity.mostActiveHour}:00`;
                if (el('most-active-day')) el('most-active-day').textContent = activity.mostActiveDay;
                if (el('peak-players')) el('peak-players').textContent = activity.peakPlayers;
                if (el('peak-players-date')) el('peak-players-date').textContent = activity.peakPlayersDate;
                
                renderHourlyChart(activity.hourlyActivity);
            } catch (e) {
                console.error('Error loading activity stats:', e);
            }
        }
        
        function renderHourlyChart(hourlyData) {
            const container = document.getElementById('hourly-chart');
            if (!container || !hourlyData) return;
            
            const maxValue = Math.max(...Object.values(hourlyData), 1);
            const sortedEntries = Object.entries(hourlyData).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            container.innerHTML = sortedEntries.map(([hour, count]) => {
                const heightPx = Math.max(Math.round((count / maxValue) * 128), 2);
                const color = count === maxValue ? 'bg-yellow-400' : 'bg-green-500';
                return `
                    <div class="flex-1 flex flex-col items-center justify-end h-full" title="${hour}:00 - ${count} eventos">
                        <div class="${color} w-full rounded-t transition-all duration-300" style="height: ${heightPx}px"></div>
                    </div>
                `;
            }).join('');
        }
        
        // ================= SESSION STATS =================
        async function loadSessionStats() {
            try {
                const sessions = await fetch('/api/sessions?days=30').then(r => r.json());
                
                const el = (id) => document.getElementById(id);
                if (el('total-sessions')) el('total-sessions').textContent = sessions.totalSessions;
                if (el('avg-session')) el('avg-session').textContent = sessions.averageSessionFormatted;
                
                if (sessions.longestSession) {
                    if (el('longest-session')) el('longest-session').textContent = sessions.longestSession.durationFormatted;
                    if (el('longest-session-player')) el('longest-session-player').textContent = sessions.longestSession.playerName;
                }
                
                const container = document.getElementById('recent-sessions');
                if (container && sessions.recentSessions) {
                    if (sessions.recentSessions.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-sm">Sin sesiones recientes</p>';
                    } else {
                        container.innerHTML = sessions.recentSessions.slice(0, 10).map(s => `
                            <div class="flex justify-between items-center py-1 border-b border-gray-700/30 text-sm">
                                <span class="text-white">${s.playerName}</span>
                                <span class="text-gray-400 text-xs">${s.joinTime}</span>
                                <span class="${s.durationFormatted === 'En l√≠nea' ? 'text-green-400' : 'text-purple-400'} font-mono">
                                    ${s.durationFormatted || '-'}
                                </span>
                            </div>
                        `).join('');
                    }
                }
            } catch (e) {
                console.error('Error loading session stats:', e);
            }
        }
        
        // ================= EVENTS =================
        function addEvent(event, serverTime) {
            const feed = document.getElementById('events-feed');
            if (!feed) return;
            
            const firstChild = feed.firstElementChild;
            if (firstChild && firstChild.textContent.includes('Esperando')) {
                feed.innerHTML = '';
            }
            
            let icon, color;
            switch(event.type) {
                case 'JOIN': icon = 'sign-in-alt'; color = 'green'; break;
                case 'LEAVE': icon = 'sign-out-alt'; color = 'red'; break;
                case 'DEATH': icon = 'skull'; color = 'pink'; break;
                case 'ADVANCEMENT': icon = 'trophy'; color = 'yellow'; break;
                case 'CHAT': icon = 'comment'; color = 'blue'; break;
                default: icon = 'info-circle'; color = 'gray';
            }
            
            const dateTime = event.fullDateTime || event.timestamp;
            const eventHtml = `
                <div class="flex items-start space-x-2 py-1 event-enter border-b border-gray-700/50 last:border-0">
                    <span class="text-${color}-400 w-5"><i class="fas fa-${icon}"></i></span>
                    <span class="text-gray-500 text-xs whitespace-nowrap">${dateTime}</span>
                    <span class="text-sm flex-1">${event.message}</span>
                </div>
            `;
            
            feed.insertAdjacentHTML('afterbegin', eventHtml);
            while (feed.children.length > 20) feed.removeChild(feed.lastChild);
        }
        
        function addChatMessage(event) {
            const feed = document.getElementById('chat-feed');
            if (!feed) return;
            
            const firstChild = feed.firstElementChild;
            if (firstChild && firstChild.textContent.includes('Cargando')) {
                feed.innerHTML = '';
            }
            
            const dateTime = event.fullDateTime || event.timestamp;
            const chatHtml = `
                <div class="py-1 event-enter border-b border-gray-700/50 last:border-0">
                    <span class="text-gray-500 text-xs">${dateTime}</span>
                    <span class="text-green-400 font-bold">&lt;${event.playerName}&gt;</span>
                    <span class="text-sm">${event.message}</span>
                </div>
            `;
            
            feed.insertAdjacentHTML('afterbegin', chatHtml);
            while (feed.children.length > 30) feed.removeChild(feed.lastChild);
        }
        
        // ================= UTILITY FUNCTIONS =================
        function formatNumber(num) {
            return (num || 0).toLocaleString('es-ES');
        }
        
        function formatKm(cm) {
            const km = (cm || 0) / 100000;
            return km.toFixed(1) + ' km';
        }
        
        function animateStat(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            
            const oldValue = el.textContent;
            el.textContent = value;
            
            if (oldValue !== '-' && oldValue !== value) {
                el.classList.add('stat-update');
                setTimeout(() => el.classList.remove('stat-update'), 500);
            }
        }
        
        // ================= START =================
        connect();
    </script>
</body>
</html>
